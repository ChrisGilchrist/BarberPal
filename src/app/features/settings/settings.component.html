<div class="settings">
  <div class="page-header">
    <h1>Settings</h1>
    <p>Manage your business settings and preferences</p>
  </div>

  @if (isLoading()) {
    <div class="loading-state">
      <div class="spinner"></div>
    </div>
  } @else {
    <div class="settings-layout">
      <aside class="settings-nav">
        <button
          class="nav-item"
          [class.active]="activeTab() === 'business'"
          (click)="setActiveTab('business')"
        >
          Business Info
        </button>
        <button
          class="nav-item"
          [class.active]="activeTab() === 'hours'"
          (click)="setActiveTab('hours')"
        >
          Working Hours
        </button>
        <button
          class="nav-item"
          [class.active]="activeTab() === 'invite'"
          (click)="setActiveTab('invite')"
        >
          Invite Clients
        </button>
        <button
          class="nav-item"
          [class.active]="activeTab() === 'notifications'"
          (click)="setActiveTab('notifications')"
        >
          Notifications
        </button>
      </aside>

      <main class="settings-content">
        @if (message(); as msg) {
          <div class="alert" [class.alert-success]="msg.type === 'success'" [class.alert-error]="msg.type === 'error'">
            {{ msg.text }}
          </div>
        }

        <!-- Business Info Tab -->
        @if (activeTab() === 'business') {
          <div class="settings-card card card-static">
            <h2>Business Information</h2>
            <form (ngSubmit)="saveBusinessInfo()">
              <div class="form-group">
                <label for="businessName">Business Name</label>
                <input
                  type="text"
                  id="businessName"
                  [(ngModel)]="businessName"
                  name="businessName"
                  class="form-control"
                  placeholder="Your Barbershop Name"
                  required
                />
              </div>

              <div class="form-group">
                <label for="businessAddress">Address</label>
                <input
                  type="text"
                  id="businessAddress"
                  [(ngModel)]="businessAddress"
                  name="businessAddress"
                  class="form-control"
                  placeholder="123 Main Street, City"
                />
              </div>

              <div class="form-group">
                <label for="businessPhone">Phone</label>
                <input
                  type="tel"
                  id="businessPhone"
                  [(ngModel)]="businessPhone"
                  name="businessPhone"
                  class="form-control"
                  placeholder="(555) 123-4567"
                />
              </div>

              <div class="form-group">
                <label for="bufferMinutes">Buffer Time Between Appointments</label>
                <select
                  id="bufferMinutes"
                  [(ngModel)]="bufferMinutes"
                  name="bufferMinutes"
                  class="form-control"
                >
                  <option [value]="0">No buffer</option>
                  <option [value]="5">5 minutes</option>
                  <option [value]="10">10 minutes</option>
                  <option [value]="15">15 minutes</option>
                  <option [value]="30">30 minutes</option>
                </select>
                <p class="form-hint">Time between appointments for cleanup and preparation</p>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary" [disabled]="isSaving()">
                  @if (isSaving()) {
                    <span class="spinner spinner-small"></span> Saving...
                  } @else {
                    Save Changes
                  }
                </button>
              </div>
            </form>
          </div>
        }

        <!-- Working Hours Tab -->
        @if (activeTab() === 'hours') {
          <div class="settings-card card card-static">
            <h2>Working Hours</h2>
            <p class="section-desc">Set your regular business hours. Clients will only be able to book during these times.</p>

            <div class="hours-list">
              @for (day of workingHours(); track day.day; let i = $index) {
                <div class="hours-row" [class.inactive]="!day.isActive">
                  <div class="day-toggle">
                    <label class="toggle">
                      <input
                        type="checkbox"
                        [checked]="day.isActive"
                        (change)="toggleDay(i)"
                      />
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="day-name">{{ day.name }}</span>
                  </div>

                  @if (day.isActive) {
                    <div class="time-inputs">
                      <input
                        type="time"
                        [value]="day.startTime"
                        (change)="updateDayTime(i, 'startTime', $any($event.target).value)"
                        class="form-control time-input"
                      />
                      <span class="time-separator">to</span>
                      <input
                        type="time"
                        [value]="day.endTime"
                        (change)="updateDayTime(i, 'endTime', $any($event.target).value)"
                        class="form-control time-input"
                      />
                    </div>
                  } @else {
                    <span class="closed-label">Closed</span>
                  }
                </div>
              }
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-primary" (click)="saveWorkingHours()" [disabled]="isSaving()">
                @if (isSaving()) {
                  <span class="spinner spinner-small"></span> Saving...
                } @else {
                  Save Working Hours
                }
              </button>
            </div>
          </div>

          <!-- Recurring Time Blocks Section -->
          <div class="settings-card card card-static">
            <div class="card-header-row">
              <div>
                <h2>Weekly Time Blocks</h2>
                <p class="section-desc">Block off recurring weekly time for lunch breaks or personal time. These slots won't be available for booking.</p>
              </div>
              <button type="button" class="btn btn-outline" (click)="openBlockModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
                Add Block
              </button>
            </div>

            @if (recurringBlocks().length === 0) {
              <div class="empty-state">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="3" y="4" width="18" height="18" rx="2"/>
                  <path d="M16 2v4M8 2v4M3 10h18"/>
                  <path d="M9 16l6-6M9 10l6 6" opacity="0.5"/>
                </svg>
                <p>No recurring time blocks</p>
                <span class="empty-hint">Add weekly blocks for lunch breaks or personal time</span>
              </div>
            } @else {
              <div class="time-blocks-list">
                @for (block of recurringBlocks(); track block.id) {
                  <div class="time-block-item">
                    <div class="time-block-info">
                      <span class="time-block-day">{{ dayNames[block.day_of_week] }}s</span>
                      <span class="time-block-range">{{ formatBlockTime(block.start_time) }} - {{ formatBlockTime(block.end_time) }}</span>
                      @if (block.reason) {
                        <span class="time-block-reason">{{ block.reason }}</span>
                      }
                    </div>
                    <button
                      type="button"
                      class="btn btn-ghost btn-icon btn-sm"
                      (click)="deleteTimeBlock(block.id)"
                      title="Delete block"
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                      </svg>
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        }

        <!-- Invite Clients Tab -->
        @if (activeTab() === 'invite') {
          <div class="settings-card">
            <h2>Invite Clients</h2>
            <p class="section-desc">Share your invite link with clients so they can easily book appointments with you.</p>

            <div class="invite-section">
              <div class="invite-link-box">
                <label>Your Invite Link</label>
                <div class="link-input-group">
                  <input
                    type="text"
                    [value]="inviteLink()"
                    readonly
                    class="form-control link-input"
                  />
                  <button
                    type="button"
                    class="btn btn-primary copy-btn"
                    (click)="copyInviteLink()"
                  >
                    @if (linkCopied()) {
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                      </svg>
                      Copied!
                    } @else {
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                      </svg>
                      Copy Link
                    }
                  </button>
                </div>
              </div>

              <div class="invite-instructions">
                <h3>How it works</h3>
                <ol>
                  <li>Share your invite link with clients via text, email, or social media</li>
                  <li>Clients click the link and create an account</li>
                  <li>They're automatically linked to your business and can book appointments</li>
                </ol>
              </div>

              <div class="share-options">
                <h3>Quick Share</h3>
                <div class="share-buttons">
                  <button type="button" class="btn btn-outline share-btn" (click)="copyInviteLink()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                      <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                    </svg>
                    Copy
                  </button>
                  <a
                    class="btn btn-outline share-btn"
                    [href]="'sms:?body=Book your next appointment with me: ' + inviteLink()"
                  >
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                    </svg>
                    Text
                  </a>
                  <a
                    class="btn btn-outline share-btn"
                    [href]="'mailto:?subject=Book an Appointment&body=Book your next appointment with me: ' + inviteLink()"
                  >
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                      <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Email
                  </a>
                </div>
              </div>
            </div>
          </div>
        }

        <!-- Notifications Tab -->
        @if (activeTab() === 'notifications') {
          <!-- Your Push Notifications -->
          @if (pushService.isSupported()) {
            <div class="settings-card card card-static">
              <h2>Your Push Notifications</h2>
              <p class="section-desc">Get instant alerts on your device for new bookings and updates.</p>

              <div class="push-settings">
                <div class="notification-option">
                  <label class="toggle-label">
                    <span class="toggle">
                      <input
                        type="checkbox"
                        [checked]="pushService.isSubscribed()"
                        (change)="togglePushNotifications()"
                        [disabled]="pushService.isLoading() || pushService.permissionState() === 'denied'"
                      />
                      <span class="toggle-slider"></span>
                    </span>
                    <div class="option-info">
                      <span class="option-title">Enable push notifications</span>
                      <span class="option-desc">
                        @switch (pushService.permissionState()) {
                          @case ('denied') {
                            Notifications blocked. Enable in browser settings.
                          }
                          @case ('granted') {
                            Receive alerts for new bookings, cancellations, and updates
                          }
                          @default {
                            Get notified about important updates instantly
                          }
                        }
                      </span>
                    </div>
                  </label>
                </div>

                @if (pushService.isSubscribed()) {
                  <div class="push-info">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                      <path d="M13.73 21a2 2 0 01-3.46 0"/>
                    </svg>
                    <span>You'll receive alerts for: new bookings, cancellations, reschedules, and reminders</span>
                  </div>
                  <div class="push-actions">
                    <button
                      type="button"
                      class="btn btn-outline btn-sm"
                      (click)="sendTestNotification()"
                      [disabled]="pushService.isLoading()"
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 01-3.46 0"/>
                      </svg>
                      Send Test
                    </button>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Client Notification Settings -->
          <div class="settings-card card card-static">
            <h2>Client Notifications</h2>
            <p class="section-desc">Configure automatic notifications sent to your clients.</p>

            <div class="notification-options">
              <div class="notification-option">
                <label class="toggle-label">
                  <span class="toggle">
                    <input
                      type="checkbox"
                      [checked]="clientNotificationsEnabled()"
                      (change)="toggleClientNotifications()"
                    />
                    <span class="toggle-slider"></span>
                  </span>
                  <div class="option-info">
                    <span class="option-title">Send client notifications</span>
                    <span class="option-desc">Enable automatic notifications to clients about their appointments</span>
                  </div>
                </label>
              </div>

              @if (clientNotificationsEnabled()) {
                <div class="reminder-timing">
                  <label class="form-label">Appointment Reminder Timing</label>
                  <p class="form-hint" style="margin-bottom: var(--space-3);">When should clients receive a reminder before their appointment?</p>
                  <div class="radio-group">
                    <label class="radio-option" [class.active]="reminderHours() === 48">
                      <input
                        type="radio"
                        name="reminderHours"
                        [value]="48"
                        [checked]="reminderHours() === 48"
                        (change)="updateReminderHours(48)"
                      />
                      <span class="radio-label">48 hours before</span>
                    </label>
                    <label class="radio-option" [class.active]="reminderHours() === 24">
                      <input
                        type="radio"
                        name="reminderHours"
                        [value]="24"
                        [checked]="reminderHours() === 24"
                        (change)="updateReminderHours(24)"
                      />
                      <span class="radio-label">24 hours before</span>
                      <span class="radio-badge">Recommended</span>
                    </label>
                    <label class="radio-option" [class.active]="reminderHours() === 2">
                      <input
                        type="radio"
                        name="reminderHours"
                        [value]="2"
                        [checked]="reminderHours() === 2"
                        (change)="updateReminderHours(2)"
                      />
                      <span class="radio-label">2 hours before</span>
                    </label>
                  </div>
                </div>

                <div class="notification-types">
                  <label class="form-label">Notification Types</label>
                  <div class="notification-option">
                    <label class="toggle-label">
                      <span class="toggle">
                        <input type="checkbox" checked disabled />
                        <span class="toggle-slider"></span>
                      </span>
                      <div class="option-info">
                        <span class="option-title">Booking Confirmation</span>
                        <span class="option-desc">When an appointment is booked</span>
                      </div>
                    </label>
                  </div>
                  <div class="notification-option">
                    <label class="toggle-label">
                      <span class="toggle">
                        <input type="checkbox" checked disabled />
                        <span class="toggle-slider"></span>
                      </span>
                      <div class="option-info">
                        <span class="option-title">Appointment Reminders</span>
                        <span class="option-desc">Before scheduled appointments</span>
                      </div>
                    </label>
                  </div>
                  <div class="notification-option">
                    <label class="toggle-label">
                      <span class="toggle">
                        <input type="checkbox" checked disabled />
                        <span class="toggle-slider"></span>
                      </span>
                      <div class="option-info">
                        <span class="option-title">Cancellation Notices</span>
                        <span class="option-desc">When appointments are cancelled</span>
                      </div>
                    </label>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </main>
    </div>
  }
</div>

<!-- Recurring Time Block Modal -->
@if (showBlockModal()) {
  <div class="modal-overlay" (click)="closeBlockModal()">
    <div class="modal modal--sm" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h2>Add Weekly Block</h2>
        <button class="modal__close" (click)="closeBlockModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div class="modal__body">
        <div class="form-group">
          <label>Day of Week</label>
          <select class="form-control" [value]="blockDay()" (change)="blockDay.set(+$any($event.target).value)">
            @for (day of dayNames; track day; let i = $index) {
              <option [value]="i">{{ day }}</option>
            }
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Start Time</label>
            <select class="form-control" [value]="blockStartTime()" (change)="blockStartTime.set($any($event.target).value)">
              @for (time of timeOptions; track time) {
                <option [value]="time">{{ formatTimeOption(time) }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label>End Time</label>
            <select class="form-control" [value]="blockEndTime()" (change)="blockEndTime.set($any($event.target).value)">
              @for (time of timeOptions; track time) {
                <option [value]="time">{{ formatTimeOption(time) }}</option>
              }
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Reason (optional)</label>
          <input
            type="text"
            class="form-control"
            placeholder="e.g., Lunch break"
            [value]="blockReason()"
            (input)="blockReason.set($any($event.target).value)"
          />
          <div class="quick-reasons">
            <button type="button" class="quick-reason" (click)="blockReason.set('Lunch Break')">Lunch Break</button>
            <button type="button" class="quick-reason" (click)="blockReason.set('Personal Time')">Personal Time</button>
          </div>
        </div>

        <p class="form-hint recurring-hint">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 1l4 4-4 4"/>
            <path d="M3 11V9a4 4 0 014-4h14"/>
            <path d="M7 23l-4-4 4-4"/>
            <path d="M21 13v2a4 4 0 01-4 4H3"/>
          </svg>
          This block will repeat every week
        </p>
      </div>

      <div class="modal__footer">
        <button type="button" class="btn btn-ghost" (click)="closeBlockModal()">Cancel</button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="saveTimeBlock()"
          [disabled]="savingBlock()"
        >
          @if (savingBlock()) {
            <span class="spinner spinner-small"></span> Saving...
          } @else {
            Save Block
          }
        </button>
      </div>
    </div>
  </div>
}
